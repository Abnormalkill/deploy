{% extends "base.html" %}

{% block title %}Study Hub - {{ user.name }}{% endblock %}

{% block head_extras %}
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket;
        
        document.addEventListener('DOMContentLoaded', function() {
            socket = io();
            var chatbox = document.getElementById('chat-messages');

            // Handle incoming messages
            socket.on('new_message', function(msg) {
                var messageElement = document.createElement('div');
                messageElement.className = 'message-entry';
                // Displaying sender name/email as sent by the server
                messageElement.innerHTML = `<strong>[${msg.time}] ${msg.sender}:</strong> ${msg.content}`;
                chatbox.appendChild(messageElement);
                chatbox.scrollTop = chatbox.scrollHeight;
            });

            // Handle sending messages on form submit
            document.getElementById('message-form').onsubmit = function(e) {
                e.preventDefault();
                var input = document.getElementById('message-input');
                var message = input.value;
                if (message) {
                    socket.emit('send_message', { 'message': message });
                    input.value = '';
                }
            };
            // Initial scroll to bottom (for history)
            chatbox.scrollTop = chatbox.scrollHeight; 
        });
    </script>
{% endblock %}

{% block content %}
<h1 class="neon-glow" style="padding: 20px; text-align: center;">Study Hub - Global Group</h1>

<div class="hub-layout">
    
    <div class="chat-panel">
        <h2 class="neon-text" style="text-align: center; border-bottom: 1px solid var(--neon-glow); padding: 10px 0;">Group Chat</h2>
        <div id="chat-messages" class="chat-messages">
            {% for msg in messages|reverse %}
                <div class="message-entry">
                    <strong>[{{ msg.timestamp.strftime('%H:%M') }}] {{ msg.sender_email }}:</strong> {{ msg.content }}
                </div>
            {% endfor %}
        </div>
        <form id="message-form" style="padding: 10px; display: flex;">
            <input type="text" id="message-input" placeholder="Type your message..." style="flex-grow: 1; margin-bottom: 0;">
            <button type="submit" style="width: 100px; margin-left: 10px;" class="form-button">Send</button>
        </form>
    </div>

    <div class="materials-panel">
        <h2 class="neon-text" style="text-align: center; border-bottom: 1px solid var(--neon-glow); padding: 10px 0;">Shared Materials</h2>
        
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('study_hub') }}">
            <p>Upload new material:</p>
            <input type="file" name="study_file" required style="color: var(--dark-text); margin-bottom: 10px; border: 1px solid var(--neon-glow); border-left: none;">
            <button type="submit" class="form-button">Upload File</button>
        </form>

        <div class="materials-list">
            {% if materials %}
                {% for material in materials %}
                    <a href="{{ url_for('uploaded_file', filename=material.file_url.split('/')[-1]) }}" target="_blank">
                        <i class="fas fa-file-download"></i> {{ material.filename }} (by {{ material.uploader_email }})
                    </a>
                {% endfor %}
            {% else %}
                <p style="text-align: center; margin-top: 20px;">No materials uploaded yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}